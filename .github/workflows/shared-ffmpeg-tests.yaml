name: FFmpeg Tests

on:
  workflow_call:
    inputs:
      ffmpeg_version:
        description: 'FFmpeg version to build (3-component version, e.g., 7.1.0)'
        required: true
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg-lgpl-image
          path: /tmp

      - name: Load Docker image
        run: |
          docker load -i /tmp/ffmpeg-lgpl-image.tar

      - name: Build test image
        run: |
          docker build -t ffmpeg-tests:latest ./ffmpeg.tests

      - name: Verify FFmpeg version
        run: |
          VERSION_OUTPUT=$(docker run --rm ffmpeg-tests:latest ffmpeg -version)

          if echo "$VERSION_OUTPUT" | grep -q -- "ffmpeg version ${{ inputs.ffmpeg_version }}-lgpl"; then
            echo "✓ Version is correct"
          else
            echo "✗ ERROR: Version is not correct in the build!"
            exit 1
          fi

      - name: Verify FFmpeg banner LGPL compliance
        run: |
          LICENSE_OUTPUT=$(docker run --rm ffmpeg-tests:latest ffmpeg -hide_banner -L)

          if echo "$LICENSE_OUTPUT" | grep -q -- "GNU Lesser General Public License"; then
            echo "✓ GNU Lesser General Public License is present"
          else
            echo "✗ ERROR: GNU Lesser General Public License is not present!"
            exit 1
          fi

          if echo "$LICENSE_OUTPUT" | grep -q -- "GNU General Public License"; then
            echo "✗ ERROR: GNU General Public License is present!"
            exit 1
          else
            echo "✓ GNU General Public License is not present"
          fi

          if echo "$LICENSE_OUTPUT" | grep -q -- "nonfree"; then
            echo "✗ ERROR: nonfree is present!"
            exit 1
          else
            echo "✓ nonfree is not present"
          fi

      - name: Verify LGPL configuration
        run: |
          BUILD_CONFIG=$(docker run --rm ffmpeg-tests:latest ffmpeg -version)
          
          if echo "$BUILD_CONFIG" | grep -q -- "--enable-gpl"; then
            echo "✗ ERROR: GPL is enabled in the build!"
            echo "This build is NOT LGPL compliant."
            exit 1
          else
            echo "✓ GPL is disabled - LGPL compliant"
          fi
          
          if echo "$BUILD_CONFIG" | grep -q -- "--enable-version3"; then
            echo "✓ Version 3 licenses enabled"
          else
            echo "✗ Version 3 licenses not enabled"
            exit 1
          fi

      - name: Verify HLS demuxer presence
        run: |
          DEMUXERS_OUTPUT=$(docker run --rm ffmpeg-tests:latest ffmpeg -demuxers)

          if echo "$DEMUXERS_OUTPUT" | grep -E '^[[:space:]]*D[[:space:]]+hls\b' > /dev/null; then
            echo "✓ HLS demuxer is present"
          else
            echo "✗ HLS demuxer is not present"
            exit 1
          fi
